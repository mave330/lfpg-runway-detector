<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LFPG Live Runway Detector</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050a0e;
    --panel: #0a1520;
    --border: #0f3a52;
    --accent: #00d4ff;
    --accent2: #00ff9d;
    --warn: #ff6b35;
    --dim: #1a3a4a;
    --text: #c8e8f0;
    --text-dim: #4a7a8a;
    --rwy-active: #00ff9d;
    --rwy-inactive: #1a3a4a;
    --grid: rgba(0,212,255,0.04);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.15) 2px,
      rgba(0,0,0,0.15) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  /* Grid background */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 1;
    border-bottom: 1px solid var(--border);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(180deg, rgba(0,30,50,0.9) 0%, transparent 100%);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    position: relative;
  }

  .logo-icon svg { width: 100%; height: 100%; }

  h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-transform: uppercase;
  }

  .subtitle {
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.2em;
    margin-top: 2px;
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    display: inline-block;
    margin-right: 6px;
  }

  .status-dot.live {
    background: var(--accent2);
    box-shadow: 0 0 8px var(--accent2);
    animation: pulse 2s infinite;
  }

  .status-dot.error { background: var(--warn); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .main-grid {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 1fr 380px;
    grid-template-rows: auto 1fr;
    gap: 0;
    height: calc(100vh - 73px);
  }

  /* ── RUNWAY DIAGRAM ── */
  .runway-panel {
    grid-row: 1 / 3;
    grid-column: 1;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px;
    gap: 20px;
  }

  .panel-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    color: var(--text-dim);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
    margin-bottom: 4px;
  }

  .airport-info {
    display: flex;
    gap: 24px;
    font-size: 0.72rem;
  }

  .airport-info span { color: var(--text-dim); }
  .airport-info strong { color: var(--accent); font-size: 1.1em; }

  .radar-container {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas#radarCanvas {
    border-radius: 50%;
    box-shadow:
      0 0 0 1px var(--border),
      0 0 40px rgba(0,212,255,0.05),
      inset 0 0 60px rgba(0,0,0,0.5);
  }

  /* ── RIGHT PANELS ── */
  .right-top {
    border-bottom: 1px solid var(--border);
    padding: 20px;
  }

  .right-bottom {
    padding: 20px;
    overflow-y: auto;
  }

  /* ── ACTIVE RUNWAYS ── */
  .runways-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 14px;
  }

  .runway-card {
    border: 1px solid var(--rwy-inactive);
    border-radius: 4px;
    padding: 14px 12px;
    background: rgba(0,0,0,0.3);
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .runway-card.active {
    border-color: var(--rwy-active);
    background: rgba(0,255,157,0.04);
    box-shadow: 0 0 20px rgba(0,255,157,0.12), inset 0 0 20px rgba(0,255,157,0.03);
  }

  .runway-card.active::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--rwy-active);
    box-shadow: 0 0 8px var(--rwy-active);
  }

  .rwy-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-dim);
    transition: color 0.4s;
  }

  .runway-card.active .rwy-name { color: var(--rwy-active); }

  .rwy-hdg {
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .rwy-count {
    position: absolute;
    top: 10px; right: 10px;
    font-size: 0.65rem;
    color: var(--text-dim);
    background: var(--dim);
    padding: 2px 6px;
    border-radius: 2px;
  }

  .runway-card.active .rwy-count {
    background: rgba(0,255,157,0.15);
    color: var(--rwy-active);
  }

  /* ── AIRCRAFT TABLE ── */
  .aircraft-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.68rem;
  }

  .aircraft-table th {
    text-align: left;
    color: var(--text-dim);
    font-weight: normal;
    padding: 4px 6px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 0.1em;
    font-size: 0.6rem;
  }

  .aircraft-table td {
    padding: 6px 6px;
    border-bottom: 1px solid rgba(15,58,82,0.5);
    vertical-align: middle;
    white-space: nowrap;
  }

  .aircraft-table tr:hover td { background: rgba(0,212,255,0.03); }

  .callsign {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.65rem;
    color: var(--accent);
  }

  .on-approach {
    color: var(--accent2);
    font-size: 0.6rem;
  }

  .badge {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 2px;
    font-size: 0.58rem;
    border: 1px solid currentColor;
  }

  .badge.approach {
    color: var(--accent2);
    background: rgba(0,255,157,0.08);
  }

  .badge.landing {
    color: #fff;
    background: var(--warn);
    border-color: var(--warn);
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .refresh-btn {
    font-family: 'Share Tech Mono', monospace;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 6px 14px;
    font-size: 0.68rem;
    cursor: pointer;
    letter-spacing: 0.1em;
    transition: all 0.2s;
    border-radius: 2px;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .refresh-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .update-time {
    font-size: 0.62rem;
    color: var(--text-dim);
    margin-left: 10px;
  }

  .empty-state {
    text-align: center;
    padding: 30px;
    color: var(--text-dim);
    font-size: 0.72rem;
    line-height: 1.8;
  }

  .cors-notice {
    background: rgba(255,107,53,0.08);
    border: 1px solid var(--warn);
    border-radius: 4px;
    padding: 12px;
    font-size: 0.67rem;
    color: #ffaa80;
    line-height: 1.6;
    margin-top: 10px;
  }

  .cors-notice a { color: var(--warn); }

  /* ── RUNWAY DIAGRAM (SVG based) ── */
  .rwy-diagram-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 0;
  }

  .stat-row {
    display: flex;
    gap: 20px;
    margin-top: 4px;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .stat-val {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
  }

  .stat-lbl {
    font-size: 0.58rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
  }

  .divider { width: 1px; background: var(--border); align-self: stretch; }

  /* Spinning radar sweep indicator */
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 36 36" fill="none">
        <circle cx="18" cy="18" r="17" stroke="#0f3a52" stroke-width="1"/>
        <circle cx="18" cy="18" r="12" stroke="#0f3a52" stroke-width="0.5" stroke-dasharray="2 3"/>
        <path d="M18 4 L21 18 L18 20 L15 18 Z" fill="#00d4ff" opacity="0.9"/>
        <path d="M14 14 L18 20 L22 14" fill="none" stroke="#00d4ff" stroke-width="0.8" opacity="0.5"/>
        <circle cx="18" cy="18" r="2" fill="#00ff9d"/>
      </svg>
    </div>
    <div>
      <h1>CDG Runway Detector</h1>
      <div class="subtitle">LFPG · PARIS CHARLES DE GAULLE · LIVE ADS-B</div>
    </div>
  </div>
  <div class="status-bar">
    <div id="statusIndicator">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">INITIALIZING</span>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="fetchData()">↻ REFRESH</button>
    <span class="update-time" id="updateTime">—</span>
  </div>
</header>

<div class="main-grid">

  <!-- LEFT: Radar + Diagram -->
  <div class="runway-panel">
    <div class="panel-label">Airport Layout · LFPG · Paris-CDG</div>
    <div class="airport-info">
      <div><span>ICAO </span><strong>LFPG</strong></div>
      <div><span>ELEV </span><strong>119 ft</strong></div>
      <div><span>LAT </span><strong>49.0097°N</strong></div>
      <div><span>LON </span><strong>2.5479°E</strong></div>
      <div><span>RADIUS </span><strong>5 km</strong></div>
    </div>

    <div class="stat-row">
      <div class="stat">
        <div class="stat-val" id="acCount">—</div>
        <div class="stat-lbl">AIRCRAFT IN RANGE</div>
      </div>
      <div class="divider"></div>
      <div class="stat">
        <div class="stat-val" id="approachCount">—</div>
        <div class="stat-lbl">ON APPROACH</div>
      </div>
      <div class="divider"></div>
      <div class="stat">
        <div class="stat-val" id="activeRwyCount">—</div>
        <div class="stat-lbl">ACTIVE RUNWAYS</div>
      </div>
    </div>

    <!-- Radar canvas -->
    <div class="radar-container">
      <canvas id="radarCanvas" width="500" height="500"></canvas>
    </div>
  </div>

  <!-- RIGHT TOP: Active Runways -->
  <div class="right-top">
    <div class="panel-label">Active Runways · Inferred from Traffic</div>
    <div class="runways-grid" id="runwayCards">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- RIGHT BOTTOM: Aircraft List -->
  <div class="right-bottom">
    <div class="panel-label">Approach Traffic · Within 5km</div>
    <div id="aircraftList">
      <div class="empty-state">Waiting for data…</div>
    </div>
  </div>

</div>

<script>
// ──────────────────────────────────────────────
// LFPG Configuration
// ──────────────────────────────────────────────
const AIRPORT = {
  icao: 'LFPG',
  name: 'Paris Charles de Gaulle',
  lat: 49.0097,
  lon: 2.5479,
  radius_km: 5,
  // Runways: name, true heading for LANDING on that runway, threshold coords approx
  runways: [
    { id: '08L', heading: 83,  pair: '26R', lat: 49.0161, lon: 2.5243 },
    { id: '26R', heading: 263, pair: '08L', lat: 49.0170, lon: 2.5810 },
    { id: '08R', heading: 83,  pair: '26L', lat: 49.0012, lon: 2.4946 },
    { id: '26L', heading: 263, pair: '08R', lat: 49.0020, lon: 2.5513 },
    { id: '09L', heading: 93,  pair: '27R', lat: 49.0242, lon: 2.5279 },
    { id: '27R', heading: 273, pair: '09L', lat: 49.0250, lon: 2.5960 },
    { id: '09R', heading: 93,  pair: '27L', lat: 49.0090, lon: 2.4979 },
    { id: '27L', heading: 273, pair: '09R', lat: 49.0098, lon: 2.5660 },
  ]
};

// Bounding box ~5km around LFPG
const LAT_DEG_PER_KM = 1 / 111.0;
const LON_DEG_PER_KM = 1 / (111.0 * Math.cos(AIRPORT.lat * Math.PI / 180));
const RADIUS = AIRPORT.radius_km;

const BBOX = {
  lamin: AIRPORT.lat - RADIUS * LAT_DEG_PER_KM,
  lamax: AIRPORT.lat + RADIUS * LAT_DEG_PER_KM,
  lomin: AIRPORT.lon - RADIUS * LON_DEG_PER_KM,
  lomax: AIRPORT.lon + RADIUS * LON_DEG_PER_KM,
};

// ──────────────────────────────────────────────
// State
// ──────────────────────────────────────────────
let allAircraft = [];
let approachAircraft = [];
let activeRunways = {};
let corsError = false;

// ──────────────────────────────────────────────
// Geo utils
// ──────────────────────────────────────────────
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function headingDiff(a, b) {
  let d = Math.abs(a - b) % 360;
  return d > 180 ? 360 - d : d;
}

// ──────────────────────────────────────────────
// Identify approach aircraft & active runways
// ──────────────────────────────────────────────
function analyzeTraffic(states) {
  // OpenSky state vector fields:
  // [icao24, callsign, origin_country, time_position, last_contact,
  //  longitude, latitude, baro_altitude, on_ground, velocity,
  //  true_track, vertical_rate, sensors, geo_altitude, squawk, spi, position_source]
  const HEADING_TOLERANCE = 25; // degrees
  const MAX_ALT_M = 1500;        // below 1500m = on approach
  const MAX_VS = 0;              // descending or level

  const aircraft = states
    .filter(s => s[5] != null && s[6] != null) // has position
    .map(s => ({
      icao: s[0],
      callsign: (s[1] || '').trim() || s[0].toUpperCase(),
      lat: s[6],
      lon: s[5],
      alt_m: s[13] ?? s[7],    // geo alt preferred
      baro_m: s[7],
      on_ground: s[8],
      speed_ms: s[9],
      heading: s[10],
      vs: s[11],
    }))
    .map(ac => ({
      ...ac,
      dist_km: haversine(AIRPORT.lat, AIRPORT.lon, ac.lat, ac.lon),
    }))
    .filter(ac => ac.dist_km <= RADIUS && !ac.on_ground);

  // For each aircraft, find if it matches a runway heading
  const rwyVotes = {};
  AIRPORT.runways.forEach(r => rwyVotes[r.id] = []);

  const approaching = aircraft.map(ac => {
    let matchedRwy = null;
    let minDiff = 999;

    if (ac.heading != null && ac.alt_m != null && ac.alt_m < MAX_ALT_M) {
      AIRPORT.runways.forEach(rwy => {
        const diff = headingDiff(ac.heading, rwy.heading);
        if (diff < HEADING_TOLERANCE && diff < minDiff) {
          minDiff = diff;
          matchedRwy = rwy.id;
        }
      });
    }

    if (matchedRwy) rwyVotes[matchedRwy].push(ac);

    return { ...ac, matchedRwy, hdgDiff: minDiff };
  });

  // Active runways = those with ≥1 aircraft
  const activeRwys = {};
  AIRPORT.runways.forEach(r => {
    if (rwyVotes[r.id].length > 0) {
      activeRwys[r.id] = rwyVotes[r.id].length;
    }
  });

  return { aircraft, approaching: approaching.filter(a => a.matchedRwy), activeRwys };
}

// ──────────────────────────────────────────────
// Fetch from OpenSky
// ──────────────────────────────────────────────
async function fetchData() {
  const btn = document.getElementById('refreshBtn');
  const dot = document.getElementById('statusDot');
  const txt = document.getElementById('statusText');
  btn.disabled = true;
  dot.className = 'status-dot';
  txt.textContent = 'FETCHING…';

  const url = `/api/opensky?lamin=${BBOX.lamin.toFixed(4)}&lomin=${BBOX.lomin.toFixed(4)}&lamax=${BBOX.lamax.toFixed(4)}&lomax=${BBOX.lomax.toFixed(4)}`;


  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const states = data.states || [];

    const { aircraft, approaching, activeRwys } = analyzeTraffic(states);
    allAircraft = aircraft;
    approachAircraft = approaching;
    activeRunways = activeRwys;
    corsError = false;

    updateUI();
    dot.className = 'status-dot live';
    txt.textContent = 'LIVE';
    document.getElementById('updateTime').textContent =
      'UPD ' + new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'}) + 'Z';

  } catch (e) {
    corsError = true;
    dot.className = 'status-dot error';
    txt.textContent = 'ERROR';
    showError(e.message);
  }

  btn.disabled = false;
}

// ──────────────────────────────────────────────
// UI Updates
// ──────────────────────────────────────────────
function updateUI() {
  // Stats
  document.getElementById('acCount').textContent = allAircraft.length;
  document.getElementById('approachCount').textContent = approachAircraft.length;
  document.getElementById('activeRwyCount').textContent = Object.keys(activeRunways).length;

  // Runway cards
  const container = document.getElementById('runwayCards');
  container.innerHTML = '';
  AIRPORT.runways.forEach(rwy => {
    const isActive = activeRunways[rwy.id] != null;
    const count = activeRunways[rwy.id] || 0;
    const card = document.createElement('div');
    card.className = 'runway-card' + (isActive ? ' active' : '');
    card.innerHTML = `
      <div class="rwy-name">${rwy.id}</div>
      <div class="rwy-hdg">HDG ${String(rwy.heading).padStart(3,'0')}°</div>
      ${isActive ? `<div class="rwy-count">${count} AC</div>` : ''}
    `;
    container.appendChild(card);
  });

  // Aircraft table
  const listEl = document.getElementById('aircraftList');
  if (allAircraft.length === 0) {
    listEl.innerHTML = '<div class="empty-state">No aircraft detected in 5km radius.<br>Try refreshing — OpenSky updates every ~10s.</div>';
    drawRadar([]);
    return;
  }

  // Sort: approaching first
  const sorted = [...allAircraft].sort((a, b) => {
    const aApp = approachAircraft.find(x => x.icao === a.icao);
    const bApp = approachAircraft.find(x => x.icao === b.icao);
    if (aApp && !bApp) return -1;
    if (!aApp && bApp) return 1;
    return a.dist_km - b.dist_km;
  });

  let html = `<table class="aircraft-table">
    <thead>
      <tr>
        <th>CALLSIGN</th>
        <th>DIST</th>
        <th>ALT</th>
        <th>HDG</th>
        <th>VS</th>
        <th>STATUS</th>
      </tr>
    </thead>
    <tbody>`;

  sorted.forEach(ac => {
    const app = approachAircraft.find(x => x.icao === ac.icao);
    const alt = ac.alt_m != null ? Math.round(ac.alt_m) + 'm' : '—';
    const hdg = ac.heading != null ? String(Math.round(ac.heading)).padStart(3,'0') + '°' : '—';
    const vs = ac.vs != null ? (ac.vs > 0 ? '+' : '') + Math.round(ac.vs) + 'm/s' : '—';
    const dist = ac.dist_km.toFixed(1) + 'km';
    let badge = '';
    if (app) {
      const isLow = ac.alt_m != null && ac.alt_m < 300;
      badge = isLow
        ? `<span class="badge landing">LANDING · ${app.matchedRwy}</span>`
        : `<span class="badge approach">APPR · ${app.matchedRwy}</span>`;
    }
    html += `<tr>
      <td><span class="callsign">${ac.callsign}</span></td>
      <td>${dist}</td>
      <td>${alt}</td>
      <td>${hdg}</td>
      <td>${vs}</td>
      <td>${badge}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  listEl.innerHTML = html;

  drawRadar(allAircraft);
}

function showError(msg) {
  document.getElementById('aircraftList').innerHTML = `
    <div class="empty-state">Failed to fetch data.</div>
    <div class="cors-notice">
      <strong>⚠ Network Error:</strong> ${msg}<br><br>
      The OpenSky Network API may block browser requests due to CORS restrictions on some endpoints.
      <br><br>
      <strong>Solutions:</strong><br>
      1. Install a CORS browser extension temporarily<br>
      2. Run a local proxy: <code>npx cors-anywhere</code><br>
      3. Use the <a href="https://opensky-network.org" target="_blank">OpenSky website</a> directly<br>
      4. Register a free account at opensky-network.org for higher rate limits<br><br>
      <em>Tip: The anonymous API allows 400 req/day. Authenticated: 4000/day.</em>
    </div>`;

  // Draw empty radar
  drawRadar([]);
  document.getElementById('acCount').textContent = '—';
  document.getElementById('approachCount').textContent = '—';
  document.getElementById('activeRwyCount').textContent = '—';
  document.getElementById('runwayCards').innerHTML = '';
  AIRPORT.runways.forEach(rwy => {
    const card = document.createElement('div');
    card.className = 'runway-card';
    card.innerHTML = `<div class="rwy-name">${rwy.id}</div><div class="rwy-hdg">HDG ${String(rwy.heading).padStart(3,'0')}°</div>`;
    document.getElementById('runwayCards').appendChild(card);
  });
}

// ──────────────────────────────────────────────
// Radar Canvas
// ──────────────────────────────────────────────
let sweepAngle = 0;
let radarFrame;
let lastAircraftSnapshot = [];

function drawRadar(aircraft) {
  lastAircraftSnapshot = aircraft;
  const canvas = document.getElementById('radarCanvas');
  const size = Math.min(canvas.parentElement.clientWidth - 40, canvas.parentElement.clientHeight - 20, 500);
  canvas.width = size;
  canvas.height = size;
}

function radarLoop() {
  const canvas = document.getElementById('radarCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2, R = W/2 - 2;

  ctx.clearRect(0, 0, W, H);

  // Background
  ctx.fillStyle = '#030c14';
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI*2);
  ctx.fill();

  // Concentric rings
  [0.25, 0.5, 0.75, 1].forEach(f => {
    ctx.strokeStyle = 'rgba(0,212,255,0.08)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(cx, cy, R*f, 0, Math.PI*2);
    ctx.stroke();
  });

  // Cross hairs
  ctx.strokeStyle = 'rgba(0,212,255,0.06)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(cx, cy - R); ctx.lineTo(cx, cy + R);
  ctx.moveTo(cx - R, cy); ctx.lineTo(cx + R, cy);
  ctx.stroke();

  // Range labels
  ctx.fillStyle = 'rgba(0,212,255,0.3)';
  ctx.font = '10px Share Tech Mono';
  ctx.textAlign = 'left';
  [1.25, 2.5, 3.75, 5].forEach((km, i) => {
    ctx.fillText(km + 'km', cx + 4, cy - R*(i+1)*0.25 + 4);
  });

  // Draw runways on radar
  AIRPORT.runways.forEach(rwy => {
    const isActive = activeRunways[rwy.id] != null;
    const rwLat = rwy.lat, rwLon = rwy.lon;
    const dx = (rwLon - AIRPORT.lon) / (LON_DEG_PER_KM * RADIUS);
    const dy = -(rwLat - AIRPORT.lat) / (LAT_DEG_PER_KM * RADIUS);
    const px = cx + dx * R;
    const py = cy + dy * R;

    // Runway end marker
    ctx.strokeStyle = isActive ? 'rgba(0,255,157,0.6)' : 'rgba(0,212,255,0.2)';
    ctx.lineWidth = isActive ? 2 : 1;
    const rwyLen = 0.08; // fraction of radius
    const hdgRad = rwy.heading * Math.PI / 180;
    ctx.beginPath();
    ctx.moveTo(px - Math.sin(hdgRad)*R*rwyLen, py - (-Math.cos(hdgRad))*R*rwyLen);
    ctx.lineTo(px + Math.sin(hdgRad)*R*rwyLen, py + (-Math.cos(hdgRad))*R*rwyLen);
    ctx.stroke();

    // Label
    ctx.fillStyle = isActive ? 'rgba(0,255,157,0.9)' : 'rgba(0,212,255,0.35)';
    ctx.font = `${isActive ? 'bold ' : ''}9px Orbitron, monospace`;
    ctx.textAlign = 'center';
    ctx.fillText(rwy.id, px, py - 8);
  });

  // Sweep gradient
  const sweepGrad = ctx.createConicalGradient
    ? null
    : null; // fallback

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(sweepAngle);

  // Draw sweep as a pie slice
  const grad = ctx.createLinearGradient(0, 0, R, 0);
  grad.addColorStop(0, 'rgba(0,212,255,0.25)');
  grad.addColorStop(1, 'rgba(0,212,255,0)');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.arc(0, 0, R, -Math.PI*0.15, 0);
  ctx.closePath();
  ctx.fill();

  // Sweep line
  ctx.strokeStyle = 'rgba(0,212,255,0.6)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(R, 0);
  ctx.stroke();
  ctx.restore();

  sweepAngle += 0.015;

  // Airport center
  ctx.fillStyle = '#00d4ff';
  ctx.beginPath();
  ctx.arc(cx, cy, 3, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = 'rgba(0,212,255,0.3)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.arc(cx, cy, 8, 0, Math.PI*2);
  ctx.stroke();

  // Draw aircraft
  lastAircraftSnapshot.forEach(ac => {
    const dx = (ac.lon - AIRPORT.lon) / (LON_DEG_PER_KM * RADIUS);
    const dy = -(ac.lat - AIRPORT.lat) / (LAT_DEG_PER_KM * RADIUS);
    const px = cx + dx * R;
    const py = cy + dy * R;

    const isApproach = approachAircraft.find(x => x.icao === ac.icao);

    // Trail
    if (ac.heading != null) {
      const hdgRad = (ac.heading - 90) * Math.PI / 180;
      const trailLen = 16;
      ctx.strokeStyle = isApproach ? 'rgba(0,255,157,0.3)' : 'rgba(0,212,255,0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(px, py);
      ctx.lineTo(px - Math.cos(hdgRad)*trailLen, py - Math.sin(hdgRad)*trailLen);
      ctx.stroke();
    }

    // Dot
    const dotColor = isApproach ? '#00ff9d' : '#00d4ff';
    ctx.fillStyle = dotColor;
    ctx.beginPath();
    ctx.arc(px, py, isApproach ? 4 : 3, 0, Math.PI*2);
    ctx.fill();

    // Glow
    ctx.strokeStyle = dotColor;
    ctx.globalAlpha = 0.3;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(px, py, 6, 0, Math.PI*2);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // Callsign
    ctx.fillStyle = isApproach ? 'rgba(0,255,157,0.85)' : 'rgba(0,212,255,0.6)';
    ctx.font = '8px Share Tech Mono';
    ctx.textAlign = 'left';
    ctx.fillText(ac.callsign.substring(0, 7), px + 6, py - 4);
  });

  // Outer ring
  ctx.strokeStyle = 'rgba(0,212,255,0.3)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI*2);
  ctx.stroke();

  radarFrame = requestAnimationFrame(radarLoop);
}

// ──────────────────────────────────────────────
// Auto-refresh every 15 seconds
// ──────────────────────────────────────────────
function startAutoRefresh() {
  fetchData();
  setInterval(fetchData, 15000);
}

// Init
window.addEventListener('load', () => {
  // Init runway cards
  AIRPORT.runways.forEach(rwy => {
    const card = document.createElement('div');
    card.className = 'runway-card';
    card.innerHTML = `<div class="rwy-name">${rwy.id}</div><div class="rwy-hdg">HDG ${String(rwy.heading).padStart(3,'0')}°</div>`;
    document.getElementById('runwayCards').appendChild(card);
  });

  // Size canvas
  const canvas = document.getElementById('radarCanvas');
  const container = canvas.parentElement;
  const size = Math.min(container.clientWidth - 40, 500);
  canvas.width = size;
  canvas.height = size;

  radarLoop();
  startAutoRefresh();
});

window.addEventListener('resize', () => {
  const canvas = document.getElementById('radarCanvas');
  const container = canvas.parentElement;
  const size = Math.min(container.clientWidth - 40, 500);
  canvas.width = size;
  canvas.height = size;
});
</script>
</body>
</html>
