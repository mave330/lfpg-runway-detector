<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LFPG Live Runway Detector</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050a0e;
    --panel: #0a1520;
    --border: #0f3a52;
    --accent: #00d4ff;
    --accent2: #00ff9d;
    --warn: #ff6b35;
    --dim: #1a3a4a;
    --text: #c8e8f0;
    --text-dim: #4a7a8a;
    --rwy-active: #00ff9d;
    --rwy-inactive: #1a3a4a;
    --grid: rgba(0,212,255,0.04);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.15) 2px,
      rgba(0,0,0,0.15) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  /* Grid background */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 1;
    border-bottom: 1px solid var(--border);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(180deg, rgba(0,30,50,0.9) 0%, transparent 100%);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    position: relative;
  }

  .logo-icon svg { width: 100%; height: 100%; }

  h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-transform: uppercase;
  }

  .subtitle {
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.2em;
    margin-top: 2px;
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    display: inline-block;
    margin-right: 6px;
  }

  .status-dot.live {
    background: var(--accent2);
    box-shadow: 0 0 8px var(--accent2);
    animation: pulse 2s infinite;
  }

  .status-dot.error { background: var(--warn); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .main-grid {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 1fr 380px;
    grid-template-rows: auto 1fr;
    gap: 0;
    height: calc(100vh - 73px);
  }

  /* ── RUNWAY DIAGRAM ── */
  .runway-panel {
    grid-row: 1 / 3;
    grid-column: 1;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px;
    gap: 20px;
  }

  .panel-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    color: var(--text-dim);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
    margin-bottom: 4px;
  }

  .airport-info {
    display: flex;
    gap: 24px;
    font-size: 0.72rem;
  }

  .airport-info span { color: var(--text-dim); }
  .airport-info strong { color: var(--accent); font-size: 1.1em; }

  .diagram-container {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 0;
  }

  #rwyDiagram {
    width: 100%;
    height: 100%;
    max-height: 520px;
  }

  /* Spinning radar sweep indicator */
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  .rwy-svg-strip {
    transition: all 0.5s ease;
  }
  .rwy-svg-label {
    transition: all 0.5s ease;
    font-family: "Orbitron", sans-serif;
    font-size: 13px;
    font-weight: 700;
  }
  .rwy-svg-hdg {
    font-family: "Share Tech Mono", monospace;
    font-size: 9px;
  }
  .rwy-glow {
    transition: all 0.5s ease;
  }

  /* ── RIGHT PANELS ── */
  .right-top {
    border-bottom: 1px solid var(--border);
    padding: 20px;
  }

  .right-bottom {
    padding: 20px;
    overflow-y: auto;
  }

  /* ── ACTIVE RUNWAYS ── */
  .runways-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 14px;
  }

  .runway-card {
    border: 1px solid var(--rwy-inactive);
    border-radius: 4px;
    padding: 14px 12px;
    background: rgba(0,0,0,0.3);
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .runway-card.active {
    border-color: var(--rwy-active);
    background: rgba(0,255,157,0.04);
    box-shadow: 0 0 20px rgba(0,255,157,0.12), inset 0 0 20px rgba(0,255,157,0.03);
  }

  .runway-card.active::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--rwy-active);
    box-shadow: 0 0 8px var(--rwy-active);
  }

  .rwy-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-dim);
    transition: color 0.4s;
  }

  .runway-card.active .rwy-name { color: var(--rwy-active); }

  .rwy-hdg {
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .rwy-count {
    position: absolute;
    top: 10px; right: 10px;
    font-size: 0.65rem;
    color: var(--text-dim);
    background: var(--dim);
    padding: 2px 6px;
    border-radius: 2px;
  }

  .runway-card.active .rwy-count {
    background: rgba(0,255,157,0.15);
    color: var(--rwy-active);
  }

  /* ── AIRCRAFT TABLE ── */
  .aircraft-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.68rem;
  }

  .aircraft-table th {
    text-align: left;
    color: var(--text-dim);
    font-weight: normal;
    padding: 4px 6px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 0.1em;
    font-size: 0.6rem;
  }

  .aircraft-table td {
    padding: 6px 6px;
    border-bottom: 1px solid rgba(15,58,82,0.5);
    vertical-align: middle;
    white-space: nowrap;
  }

  .aircraft-table tr:hover td { background: rgba(0,212,255,0.03); }

  .callsign {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.65rem;
    color: var(--accent);
  }

  .on-approach {
    color: var(--accent2);
    font-size: 0.6rem;
  }

  .badge {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 2px;
    font-size: 0.58rem;
    border: 1px solid currentColor;
  }

  .badge.approach {
    color: var(--accent2);
    background: rgba(0,255,157,0.08);
  }

  .badge.landing {
    color: #fff;
    background: var(--warn);
    border-color: var(--warn);
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .refresh-btn {
    font-family: 'Share Tech Mono', monospace;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 6px 14px;
    font-size: 0.68rem;
    cursor: pointer;
    letter-spacing: 0.1em;
    transition: all 0.2s;
    border-radius: 2px;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .refresh-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .update-time {
    font-size: 0.62rem;
    color: var(--text-dim);
    margin-left: 10px;
  }

  .empty-state {
    text-align: center;
    padding: 30px;
    color: var(--text-dim);
    font-size: 0.72rem;
    line-height: 1.8;
  }

  .cors-notice {
    background: rgba(255,107,53,0.08);
    border: 1px solid var(--warn);
    border-radius: 4px;
    padding: 12px;
    font-size: 0.67rem;
    color: #ffaa80;
    line-height: 1.6;
    margin-top: 10px;
  }

  .cors-notice a { color: var(--warn); }

  /* ── RUNWAY DIAGRAM (SVG based) ── */
  .rwy-diagram-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 0;
  }

  .stat-row {
    display: flex;
    gap: 20px;
    margin-top: 4px;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .stat-val {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
  }

  .stat-lbl {
    font-size: 0.58rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
  }

  .divider { width: 1px; background: var(--border); align-self: stretch; }

  /* Spinning radar sweep indicator */
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 36 36" fill="none">
        <circle cx="18" cy="18" r="17" stroke="#0f3a52" stroke-width="1"/>
        <circle cx="18" cy="18" r="12" stroke="#0f3a52" stroke-width="0.5" stroke-dasharray="2 3"/>
        <path d="M18 4 L21 18 L18 20 L15 18 Z" fill="#00d4ff" opacity="0.9"/>
        <path d="M14 14 L18 20 L22 14" fill="none" stroke="#00d4ff" stroke-width="0.8" opacity="0.5"/>
        <circle cx="18" cy="18" r="2" fill="#00ff9d"/>
      </svg>
    </div>
    <div>
      <h1>CDG Runway Detector</h1>
      <div class="subtitle">LFPG · PARIS CHARLES DE GAULLE · LIVE ADS-B</div>
    </div>
  </div>
  <div class="status-bar">
    <div id="statusIndicator">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">INITIALIZING</span>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="fetchData()">↻ REFRESH</button>
    <button class="refresh-btn" onclick="toggleDebug()" style="border-color:#ff6b35;color:#ff6b35;">⚙ DEBUG</button>
    <span class="update-time" id="updateTime">—</span>
  </div>
</header>

<!-- DEBUG PANEL -->
<div id="debugPanel" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);z-index:9999;overflow-y:auto;padding:30px;font-family:Share Tech Mono,monospace;">
  <div style="max-width:800px;margin:0 auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <span style="font-family:Orbitron,sans-serif;color:#ff6b35;font-size:1rem;letter-spacing:0.2em;">⚙ DEBUG PANEL</span>
      <button onclick="toggleDebug()" style="background:transparent;border:1px solid #ff6b35;color:#ff6b35;padding:6px 14px;cursor:pointer;font-family:Share Tech Mono,monospace;">✕ CLOSE</button>
    </div>

    <div style="margin-bottom:20px;">
      <div style="color:#4a7a8a;font-size:0.65rem;letter-spacing:0.2em;margin-bottom:8px;">SERVER STATUS</div>
      <div id="debugServer" style="background:#0a1520;border:1px solid #0f3a52;padding:14px;border-radius:4px;white-space:pre;color:#c8e8f0;font-size:0.72rem;line-height:1.6;">Loading…</div>
    </div>

    <div style="margin-bottom:20px;">
      <div style="color:#4a7a8a;font-size:0.65rem;letter-spacing:0.2em;margin-bottom:8px;">OPENSKY RAW RESPONSE</div>
      <div id="debugOpensky" style="background:#0a1520;border:1px solid #0f3a52;padding:14px;border-radius:4px;white-space:pre-wrap;color:#c8e8f0;font-size:0.68rem;line-height:1.6;max-height:300px;overflow-y:auto;">Loading…</div>
    </div>

    <div style="margin-bottom:20px;">
      <div style="color:#4a7a8a;font-size:0.65rem;letter-spacing:0.2em;margin-bottom:8px;">LAST ERROR</div>
      <div id="debugError" style="background:#0a1520;border:1px solid #0f3a52;padding:14px;border-radius:4px;white-space:pre-wrap;color:#ff6b35;font-size:0.72rem;line-height:1.6;">None</div>
    </div>

    <div>
      <div style="color:#4a7a8a;font-size:0.65rem;letter-spacing:0.2em;margin-bottom:8px;">BBOX / CONFIG</div>
      <div id="debugConfig" style="background:#0a1520;border:1px solid #0f3a52;padding:14px;border-radius:4px;white-space:pre;color:#c8e8f0;font-size:0.72rem;line-height:1.6;"></div>
    </div>
  </div>
</div>

<div class="main-grid">

  <!-- LEFT: Radar + Diagram -->
  <div class="runway-panel">
    <div class="panel-label">Airport Layout · LFPG · Paris-CDG</div>
    <div class="airport-info">
      <div><span>ICAO </span><strong>LFPG</strong></div>
      <div><span>ELEV </span><strong>119 ft</strong></div>
      <div><span>LAT </span><strong>49.0097°N</strong></div>
      <div><span>LON </span><strong>2.5479°E</strong></div>
      <div><span>RADIUS </span><strong>15 nm</strong></div>
    </div>

    <div class="stat-row">
      <div class="stat">
        <div class="stat-val" id="acCount">—</div>
        <div class="stat-lbl">AIRCRAFT IN RANGE</div>
      </div>
      <div class="divider"></div>
      <div class="stat">
        <div class="stat-val" id="approachCount">—</div>
        <div class="stat-lbl">ON APPROACH</div>
      </div>
      <div class="divider"></div>
      <div class="stat">
        <div class="stat-val" id="activeRwyCount">—</div>
        <div class="stat-lbl">ACTIVE RUNWAYS</div>
      </div>
    </div>

    <!-- Runway Diagram -->
    <div class="diagram-container">
      <svg id="rwyDiagram" viewBox="0 0 600 500" xmlns="http://www.w3.org/2000/svg">
        <!-- Background -->
        <rect width="600" height="500" fill="#050a0e" rx="6"/>

        <!-- Airport boundary subtle -->
        <ellipse cx="300" cy="250" rx="270" ry="220" fill="none" stroke="rgba(0,212,255,0.05)" stroke-width="1"/>

        <!-- North indicator -->
        <g transform="translate(555,30)">
          <line x1="0" y1="14" x2="0" y2="-14" stroke="rgba(0,212,255,0.4)" stroke-width="1"/>
          <polygon points="0,-14 -4,-4 4,-4" fill="rgba(0,212,255,0.6)"/>
          <text x="0" y="26" text-anchor="middle" font-family="Share Tech Mono,monospace" font-size="9" fill="rgba(0,212,255,0.5)">N</text>
        </g>

        <!-- Scale bar -->
        <g transform="translate(24,470)">
          <line x1="0" y1="0" x2="60" y2="0" stroke="rgba(0,212,255,0.3)" stroke-width="1"/>
          <line x1="0" y1="-3" x2="0" y2="3" stroke="rgba(0,212,255,0.3)" stroke-width="1"/>
          <line x1="60" y1="-3" x2="60" y2="3" stroke="rgba(0,212,255,0.3)" stroke-width="1"/>
          <text x="30" y="-6" text-anchor="middle" font-family="Share Tech Mono,monospace" font-size="8" fill="rgba(0,212,255,0.4)">~3 km</text>
        </g>

        <!-- ═══════════════════════════════════════════
             LFPG RUNWAY LAYOUT
             Northern complex: 08L/26R and 09L/27R
             Southern complex: 08R/26L and 09R/27L
             HDG 083° and 093° (slight divergence)
             Runway length ~4km, width visual ~12px
             Northern pair: y ≈ 160 / 210
             Southern pair: y ≈ 290 / 340
        ═══════════════════════════════════════════ -->

        <!-- ── NORTHERN PAIR ── -->

        <!-- 08L / 26R  (y=155, HDG 083°) -->
        <g id="rwy_08L_26R">
          <!-- Glow layer (active) -->
          <rect id="glow_08L_26R" x="50" y="147" width="500" height="16" rx="2"
                fill="rgba(0,255,157,0)" class="rwy-glow"/>
          <!-- Strip -->
          <rect id="strip_08L_26R" x="50" y="149" width="500" height="12" rx="2"
                fill="#0f2a1a" stroke="#1a3a2a" stroke-width="1" class="rwy-svg-strip"/>
          <!-- Centerline dashes -->
          <line x1="70" y1="155" x2="530" y2="155" stroke="rgba(255,255,255,0.08)"
                stroke-width="1" stroke-dasharray="20 12"/>
          <!-- Threshold markers 08L -->
          <rect x="50" y="149" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <!-- Threshold markers 26R -->
          <rect x="542" y="149" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <!-- Labels -->
          <text id="lbl_08L" x="36" y="159" text-anchor="end" fill="#1a4a3a" class="rwy-svg-label">08L</text>
          <text id="lbl_26R" x="564" y="159" text-anchor="start" fill="#1a4a3a" class="rwy-svg-label">26R</text>
          <!-- Headings -->
          <text x="36" y="170" text-anchor="end" fill="#0f3a2a" class="rwy-svg-hdg">083°</text>
          <text x="564" y="170" text-anchor="start" fill="#0f3a2a" class="rwy-svg-hdg">263°</text>
        </g>

        <!-- 09L / 27R  (y=205, HDG 093°) — slightly angled right -->
        <g id="rwy_09L_27R">
          <rect id="glow_09L_27R" x="90" y="197" width="460" height="16" rx="2"
                fill="rgba(0,255,157,0)" class="rwy-glow"/>
          <rect id="strip_09L_27R" x="90" y="199" width="460" height="12" rx="2"
                fill="#0f2a1a" stroke="#1a3a2a" stroke-width="1" class="rwy-svg-strip"/>
          <line x1="108" y1="205" x2="532" y2="205" stroke="rgba(255,255,255,0.08)"
                stroke-width="1" stroke-dasharray="20 12"/>
          <rect x="90" y="199" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <rect x="542" y="199" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <text id="lbl_09L" x="76" y="209" text-anchor="end" fill="#1a4a3a" class="rwy-svg-label">09L</text>
          <text id="lbl_27R" x="564" y="209" text-anchor="start" fill="#1a4a3a" class="rwy-svg-label">27R</text>
          <text x="76" y="220" text-anchor="end" fill="#0f3a2a" class="rwy-svg-hdg">093°</text>
          <text x="564" y="220" text-anchor="start" fill="#0f3a2a" class="rwy-svg-hdg">273°</text>
        </g>

        <!-- Taxiway connector north -->
        <line x1="300" y1="161" x2="300" y2="199" stroke="rgba(0,212,255,0.08)" stroke-width="2"/>
        <line x1="180" y1="161" x2="180" y2="199" stroke="rgba(0,212,255,0.06)" stroke-width="1.5"/>
        <line x1="420" y1="161" x2="420" y2="199" stroke="rgba(0,212,255,0.06)" stroke-width="1.5"/>

        <!-- North terminal area suggestion -->
        <rect x="200" y="228" width="200" height="16" rx="3"
              fill="rgba(0,212,255,0.04)" stroke="rgba(0,212,255,0.08)" stroke-width="1"/>
        <text x="300" y="240" text-anchor="middle" font-family="Share Tech Mono,monospace"
              font-size="8" fill="rgba(0,212,255,0.25)">CDG 1 · CDG 2</text>

        <!-- ── SOUTHERN PAIR ── -->

        <!-- 08R / 26L  (y=295, HDG 083°) -->
        <g id="rwy_08R_26L">
          <rect id="glow_08R_26L" x="50" y="287" width="500" height="16" rx="2"
                fill="rgba(0,255,157,0)" class="rwy-glow"/>
          <rect id="strip_08R_26L" x="50" y="289" width="500" height="12" rx="2"
                fill="#0f2a1a" stroke="#1a3a2a" stroke-width="1" class="rwy-svg-strip"/>
          <line x1="70" y1="295" x2="530" y2="295" stroke="rgba(255,255,255,0.08)"
                stroke-width="1" stroke-dasharray="20 12"/>
          <rect x="50" y="289" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <rect x="542" y="289" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <text id="lbl_08R" x="36" y="299" text-anchor="end" fill="#1a4a3a" class="rwy-svg-label">08R</text>
          <text id="lbl_26L" x="564" y="299" text-anchor="start" fill="#1a4a3a" class="rwy-svg-label">26L</text>
          <text x="36" y="310" text-anchor="end" fill="#0f3a2a" class="rwy-svg-hdg">083°</text>
          <text x="564" y="310" text-anchor="start" fill="#0f3a2a" class="rwy-svg-hdg">263°</text>
        </g>

        <!-- 09R / 27L  (y=345, HDG 093°) -->
        <g id="rwy_09R_27L">
          <rect id="glow_09R_27L" x="90" y="337" width="460" height="16" rx="2"
                fill="rgba(0,255,157,0)" class="rwy-glow"/>
          <rect id="strip_09R_27L" x="90" y="339" width="460" height="12" rx="2"
                fill="#0f2a1a" stroke="#1a3a2a" stroke-width="1" class="rwy-svg-strip"/>
          <line x1="108" y1="345" x2="532" y2="345" stroke="rgba(255,255,255,0.08)"
                stroke-width="1" stroke-dasharray="20 12"/>
          <rect x="90" y="339" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <rect x="542" y="339" width="8" height="12" fill="rgba(0,212,255,0.15)" rx="1"/>
          <text id="lbl_09R" x="76" y="349" text-anchor="end" fill="#1a4a3a" class="rwy-svg-label">09R</text>
          <text id="lbl_27L" x="564" y="349" text-anchor="start" fill="#1a4a3a" class="rwy-svg-label">27L</text>
          <text x="76" y="360" text-anchor="end" fill="#0f3a2a" class="rwy-svg-hdg">093°</text>
          <text x="564" y="360" text-anchor="start" fill="#0f3a2a" class="rwy-svg-hdg">273°</text>
        </g>

        <!-- Taxiway connector south -->
        <line x1="300" y1="301" x2="300" y2="339" stroke="rgba(0,212,255,0.08)" stroke-width="2"/>
        <line x1="180" y1="301" x2="180" y2="339" stroke="rgba(0,212,255,0.06)" stroke-width="1.5"/>
        <line x1="420" y1="301" x2="420" y2="339" stroke="rgba(0,212,255,0.06)" stroke-width="1.5"/>

        <!-- South terminal area suggestion -->
        <rect x="200" y="365" width="200" height="16" rx="3"
              fill="rgba(0,212,255,0.04)" stroke="rgba(0,212,255,0.08)" stroke-width="1"/>
        <text x="300" y="377" text-anchor="middle" font-family="Share Tech Mono,monospace"
              font-size="8" fill="rgba(0,212,255,0.25)">CDG 3 · S4</text>

        <!-- North/South separator label -->
        <text x="300" y="270" text-anchor="middle" font-family="Share Tech Mono,monospace"
              font-size="8" fill="rgba(0,212,255,0.15)" letter-spacing="3">· · · · · · · · · · · · ·</text>

        <!-- Direction arrows (W side = 08x approaches, E side = 26x approaches) -->
        <text x="18" y="250" text-anchor="middle" font-family="Share Tech Mono,monospace"
              font-size="8" fill="rgba(0,212,255,0.2)" writing-mode="tb">08 APPR ▶</text>
        <text x="585" y="270" text-anchor="middle" font-family="Share Tech Mono,monospace"
              font-size="8" fill="rgba(0,212,255,0.2)" writing-mode="tb">◀ 26 APPR</text>

      </svg>
    </div>
  </div>

  <!-- RIGHT TOP: Active Runways -->
  <div class="right-top">
    <div class="panel-label">Active Runways · Inferred from Traffic</div>
    <div class="runways-grid" id="runwayCards">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- RIGHT BOTTOM: Aircraft List -->
  <div class="right-bottom">
    <div class="panel-label">Approach Traffic · Within 5km</div>
    <div id="aircraftList">
      <div class="empty-state">Waiting for data…</div>
    </div>
  </div>

</div>

<script>
// ──────────────────────────────────────────────
// LFPG Configuration
// ──────────────────────────────────────────────
// ── IMPORTANT: All LFPG runways share ~84°/264° heading.
// Distinction between parallels (08L vs 08R vs 09L vs 09R) is done
// by lateral distance to each runway centerline, NOT by heading.
//
// Runway centerline coords (midpoint lat/lon) — used for lateral offset calc.
// True headings: 08x = 84°, 26x/27x = 264°
// Source: OurAirports / Jeppesen verified
//
// LFPG layout (North to South):
//   North complex:  09L (outer/arrivals) — 09R (inner/departures)
//   South complex:  08L (inner/departures) — 08R (outer/arrivals)
// Each complex separated ~390m laterally between pairs, ~1.8km between complexes.
//
// Threshold coordinates (approximate, from charted data):
//   08L thr: 49.0150°N 2.4950°E  /  26R thr: 49.0178°N 2.5750°E
//   08R thr: 49.0060°N 2.5100°E  /  26L thr: 49.0088°N 2.5790°E  (inner south)
//   09R thr: 49.0210°N 2.5070°E  /  27L thr: 49.0238°N 2.5870°E  (inner north)
//   09L thr: 49.0280°N 2.5250°E  /  27R thr: 49.0308°N 2.6050°E  (outer north)

const AIRPORT = {
  icao: 'LFPG',
  name: 'Paris Charles de Gaulle',
  lat: 49.0128,
  lon: 2.5500,
  radius_km: 15,  // Extended to 15km to catch aircraft on final approach
  // Each runway defined by:
  //   heading: true magnetic heading to LAND on this runway
  //   clat/clon: centerline midpoint (used for lateral offset)
  //   lat/lon: landing threshold position
  runways: [
    // ── NORTH COMPLEX (09L outer / 09R inner) ──
    { id: '09L', heading: 84,  oppHeading: 264, clat: 49.0294, clon: 2.5650, lat: 49.0280, lon: 2.5250 },
    { id: '27R', heading: 264, oppHeading: 84,  clat: 49.0294, clon: 2.5650, lat: 49.0308, lon: 2.6050 },
    { id: '09R', heading: 84,  oppHeading: 264, clat: 49.0224, clon: 2.5470, lat: 49.0210, lon: 2.5070 },
    { id: '27L', heading: 264, oppHeading: 84,  clat: 49.0224, clon: 2.5470, lat: 49.0238, lon: 2.5870 },
    // ── SOUTH COMPLEX (08R outer / 08L inner) ──
    { id: '08R', heading: 84,  oppHeading: 264, clat: 49.0074, clon: 2.5445, lat: 49.0060, lon: 2.5100 },
    { id: '26L', heading: 264, oppHeading: 84,  clat: 49.0074, clon: 2.5445, lat: 49.0088, lon: 2.5790 },
    { id: '08L', heading: 84,  oppHeading: 264, clat: 49.0164, clon: 2.5350, lat: 49.0150, lon: 2.4950 },
    { id: '26R', heading: 264, oppHeading: 84,  clat: 49.0164, clon: 2.5350, lat: 49.0178, lon: 2.5750 },
  ]
};

// Bounding box around LFPG
const LAT_DEG_PER_KM = 1 / 111.0;
const LON_DEG_PER_KM = 1 / (111.0 * Math.cos(AIRPORT.lat * Math.PI / 180));
const RADIUS = AIRPORT.radius_km;

const BBOX = {
  lamin: AIRPORT.lat - RADIUS * LAT_DEG_PER_KM,
  lamax: AIRPORT.lat + RADIUS * LAT_DEG_PER_KM,
  lomin: AIRPORT.lon - RADIUS * LON_DEG_PER_KM,
  lomax: AIRPORT.lon + RADIUS * LON_DEG_PER_KM,
};

// ──────────────────────────────────────────────
// State
// ──────────────────────────────────────────────
let allAircraft = [];
let approachAircraft = [];
let activeRunways = {};
let corsError = false;

// ──────────────────────────────────────────────
// Geo utils
// ──────────────────────────────────────────────
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function headingDiff(a, b) {
  let d = Math.abs(a - b) % 360;
  return d > 180 ? 360 - d : d;
}

// ──────────────────────────────────────────────
// Lateral offset from runway centerline
// Returns signed distance in km (+left, -right of runway heading)
// ──────────────────────────────────────────────
function lateralOffsetKm(acLat, acLon, rwy) {
  // Vector from runway centerline midpoint to aircraft
  const dLat = (acLat - rwy.clat) * 111.0;
  const dLon = (acLon - rwy.clon) * 111.0 * Math.cos(rwy.clat * Math.PI / 180);
  // Perpendicular component to runway heading
  const hdgRad = rwy.heading * Math.PI / 180;
  // Cross product (lateral offset = dLon*cos(hdg) - dLat*sin(hdg))
  return dLon * Math.cos(hdgRad) - dLat * Math.sin(hdgRad);
}

// ──────────────────────────────────────────────
// Identify approach aircraft & active runways
// Uses BOTH heading AND lateral position to identify specific runway
// ──────────────────────────────────────────────
function analyzeTraffic(states) {
  // OpenSky state vector fields:
  // [icao24, callsign, origin_country, time_position, last_contact,
  //  longitude, latitude, baro_altitude, on_ground, velocity,
  //  true_track, vertical_rate, sensors, geo_altitude, squawk, spi, position_source]

  const HEADING_TOLERANCE = 20; // degrees — tighter now that we use position too
  const MAX_ALT_M = 3000;       // 3000m to catch longer finals (15km radius)
  const MAX_LATERAL_KM = 0.8;   // must be within 800m of centerline

  const aircraft = states
    .filter(s => s[5] != null && s[6] != null)
    .map(s => ({
      icao: s[0],
      callsign: (s[1] || '').trim() || s[0].toUpperCase(),
      lat: s[6],
      lon: s[5],
      alt_m: s[13] ?? s[7],
      baro_m: s[7],
      on_ground: s[8],
      speed_ms: s[9],
      heading: s[10],
      vs: s[11],
    }))
    .map(ac => ({
      ...ac,
      dist_km: haversine(AIRPORT.lat, AIRPORT.lon, ac.lat, ac.lon),
    }))
    .filter(ac => ac.dist_km <= RADIUS && !ac.on_ground);

  const rwyVotes = {};
  AIRPORT.runways.forEach(r => rwyVotes[r.id] = []);

  const approaching = aircraft.map(ac => {
    let matchedRwy = null;
    let bestScore = Infinity;

    if (ac.heading == null || ac.alt_m == null || ac.alt_m > MAX_ALT_M) {
      return { ...ac, matchedRwy: null };
    }

    // Only consider runways whose heading matches aircraft heading
    const headingOk = AIRPORT.runways.filter(rwy => headingDiff(ac.heading, rwy.heading) < HEADING_TOLERANCE);

    headingOk.forEach(rwy => {
      const lateral = Math.abs(lateralOffsetKm(ac.lat, ac.lon, rwy));
      const hdgDiff_ = headingDiff(ac.heading, rwy.heading);

      // Score = lateral distance (primary) + small heading penalty
      const score = lateral + hdgDiff_ * 0.01;

      if (lateral < MAX_LATERAL_KM && score < bestScore) {
        bestScore = score;
        matchedRwy = rwy.id;
      }
    });

    // Extra filter: aircraft must be approaching (descending OR low altitude)
    if (matchedRwy) {
      const isDescending = ac.vs != null && ac.vs < -1;
      const isLow = ac.alt_m < 800;
      if (!isDescending && !isLow) matchedRwy = null; // probably departing
    }

    if (matchedRwy) rwyVotes[matchedRwy].push(ac);
    return { ...ac, matchedRwy, lateralScore: bestScore };
  });

  const activeRwys = {};
  AIRPORT.runways.forEach(r => {
    if (rwyVotes[r.id].length > 0) {
      activeRwys[r.id] = rwyVotes[r.id].length;
    }
  });

  return { aircraft, approaching: approaching.filter(a => a.matchedRwy), activeRwys };
}

// ──────────────────────────────────────────────
// Fetch from OpenSky
// ──────────────────────────────────────────────
// adsb.lol API — free, no auth, CORS-friendly, called directly from browser
// Covers a lat/lon bounding box, returns aircraft array
async function fetchData() {
  const btn = document.getElementById('refreshBtn');
  const dot = document.getElementById('statusDot');
  const txt = document.getElementById('statusText');
  btn.disabled = true;
  dot.className = 'status-dot';
  txt.textContent = 'FETCHING…';

  const url = `/api/opensky?lamin=${BBOX.lamin.toFixed(4)}&lomin=${BBOX.lomin.toFixed(4)}&lamax=${BBOX.lamax.toFixed(4)}&lomax=${BBOX.lomax.toFixed(4)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const states = data.states || [];

    const { aircraft, approaching, activeRwys } = analyzeTraffic(states);
    allAircraft = aircraft;
    approachAircraft = approaching;
    activeRunways = activeRwys;
    corsError = false;

    updateUI();
    dot.className = 'status-dot live';
    txt.textContent = `LIVE · ${data.source || 'adsb.fi'}`;
    document.getElementById('updateTime').textContent =
      'UPD ' + new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'}) + 'Z';

  } catch (e) {
    corsError = true;
    dot.className = 'status-dot error';
    txt.textContent = 'ERROR';
    window._lastError = e.message + '\n' + new Date().toISOString();
    showError(e.message);
  }

  btn.disabled = false;
}

// ──────────────────────────────────────────────
// UI Updates
// ──────────────────────────────────────────────
function updateUI() {
  // Stats
  document.getElementById('acCount').textContent = allAircraft.length;
  document.getElementById('approachCount').textContent = approachAircraft.length;
  document.getElementById('activeRwyCount').textContent = Object.keys(activeRunways).length;

  // Runway cards
  const container = document.getElementById('runwayCards');
  container.innerHTML = '';
  AIRPORT.runways.forEach(rwy => {
    const isActive = activeRunways[rwy.id] != null;
    const count = activeRunways[rwy.id] || 0;
    const card = document.createElement('div');
    card.className = 'runway-card' + (isActive ? ' active' : '');
    card.innerHTML = `
      <div class="rwy-name">${rwy.id}</div>
      <div class="rwy-hdg">HDG ${String(rwy.heading).padStart(3,'0')}°</div>
      ${isActive ? `<div class="rwy-count">${count} AC</div>` : ''}
    `;
    container.appendChild(card);
  });

  // Aircraft table
  const listEl = document.getElementById('aircraftList');
  if (allAircraft.length === 0) {
    listEl.innerHTML = '<div class="empty-state">No aircraft detected in 5km radius.<br>Try refreshing — OpenSky updates every ~10s.</div>';
    updateDiagram();
    return;
  }

  // Sort: approaching first
  const sorted = [...allAircraft].sort((a, b) => {
    const aApp = approachAircraft.find(x => x.icao === a.icao);
    const bApp = approachAircraft.find(x => x.icao === b.icao);
    if (aApp && !bApp) return -1;
    if (!aApp && bApp) return 1;
    return a.dist_km - b.dist_km;
  });

  let html = `<table class="aircraft-table">
    <thead>
      <tr>
        <th>CALLSIGN</th>
        <th>DIST</th>
        <th>ALT</th>
        <th>HDG</th>
        <th>VS</th>
        <th>STATUS</th>
      </tr>
    </thead>
    <tbody>`;

  sorted.forEach(ac => {
    const app = approachAircraft.find(x => x.icao === ac.icao);
    const alt = ac.alt_ft != null ? Math.round(ac.alt_ft) + 'ft' : '—';
    const hdg = ac.heading != null ? String(Math.round(ac.heading)).padStart(3,'0') + '°' : '—';
    const vs = ac.vs != null ? (ac.vs > 0 ? '+' : '') + Math.round(ac.vs) + 'fpm' : '—';
    const dist = ac.dist_km.toFixed(1) + 'km';
    let badge = '';
    if (app) {
      const isLow = ac.alt_m != null && ac.alt_m < 300;
      badge = isLow
        ? `<span class="badge landing">LANDING · ${app.matchedRwy}</span>`
        : `<span class="badge approach">APPR · ${app.matchedRwy}</span>`;
    }
    html += `<tr>
      <td><span class="callsign">${ac.callsign}</span></td>
      <td>${dist}</td>
      <td>${alt}</td>
      <td>${hdg}</td>
      <td>${vs}</td>
      <td>${badge}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  listEl.innerHTML = html;

  updateDiagram();
}

function showError(msg) {
  document.getElementById('aircraftList').innerHTML = `
    <div class="empty-state" style="color:#ff6b35;">⚠ ${msg}</div>
    <div class="cors-notice">
      Click the <strong style="color:#ff6b35;">⚙ DEBUG</strong> button in the header to diagnose the issue.
    </div>`;

  // Draw empty radar
  updateDiagram();
  document.getElementById('acCount').textContent = '—';
  document.getElementById('approachCount').textContent = '—';
  document.getElementById('activeRwyCount').textContent = '—';
  document.getElementById('runwayCards').innerHTML = '';
  AIRPORT.runways.forEach(rwy => {
    const card = document.createElement('div');
    card.className = 'runway-card';
    card.innerHTML = `<div class="rwy-name">${rwy.id}</div><div class="rwy-hdg">HDG ${String(rwy.heading).padStart(3,'0')}°</div>`;
    document.getElementById('runwayCards').appendChild(card);
  });
}

// ──────────────────────────────────────────────
// SVG Runway Diagram Updater
// ──────────────────────────────────────────────

// Map each runway ID to its SVG element IDs
const RWY_SVG = {
  '08L': { pair: '08L_26R', labelId: 'lbl_08L' },
  '26R': { pair: '08L_26R', labelId: 'lbl_26R' },
  '08R': { pair: '08R_26L', labelId: 'lbl_08R' },
  '26L': { pair: '08R_26L', labelId: 'lbl_26L' },
  '09L': { pair: '09L_27R', labelId: 'lbl_09L' },
  '27R': { pair: '09L_27R', labelId: 'lbl_27R' },
  '09R': { pair: '09R_27L', labelId: 'lbl_09R' },
  '27L': { pair: '09R_27L', labelId: 'lbl_27L' },
};

function updateDiagram() {
  // Reset all runways to inactive
  const allPairs = ['08L_26R', '08R_26L', '09L_27R', '09R_27L'];
  allPairs.forEach(pair => {
    const strip = document.getElementById('strip_' + pair);
    const glow  = document.getElementById('glow_' + pair);
    if (strip) strip.setAttribute('fill', '#0f2a1a');
    if (strip) strip.setAttribute('stroke', '#1a3a2a');
    if (glow)  glow.setAttribute('fill', 'rgba(0,255,157,0)');
  });

  // Reset all labels
  Object.values(RWY_SVG).forEach(({ labelId }) => {
    const el = document.getElementById(labelId);
    if (el) {
      el.setAttribute('fill', '#1a4a3a');
      el.setAttribute('font-size', '13');
    }
  });

  // Highlight active runways
  Object.entries(activeRunways).forEach(([rwyId, count]) => {
    const cfg = RWY_SVG[rwyId];
    if (!cfg) return;

    const strip = document.getElementById('strip_' + cfg.pair);
    const glow  = document.getElementById('glow_' + cfg.pair);
    const lbl   = document.getElementById(cfg.labelId);

    if (strip) {
      strip.setAttribute('fill', '#0a2a15');
      strip.setAttribute('stroke', '#00ff9d');
    }
    if (glow) {
      glow.setAttribute('fill', 'rgba(0,255,157,0.12)');
    }
    if (lbl) {
      lbl.setAttribute('fill', '#00ff9d');
      lbl.setAttribute('font-size', '14');
    }
  });
}

function drawRadar() {
  updateDiagram();
}

// ──────────────────────────────────────────────
// Auto-refresh every 15 seconds
// ──────────────────────────────────────────────
function startAutoRefresh() {
  fetchData();
  setInterval(fetchData, 15000);
}

// ──────────────────────────────────────────────
// Debug Panel
// ──────────────────────────────────────────────
let _debugOpen = false;

async function toggleDebug() {
  _debugOpen = !_debugOpen;
  const panel = document.getElementById('debugPanel');
  panel.style.display = _debugOpen ? 'block' : 'none';
  if (_debugOpen) await refreshDebug();
}

async function refreshDebug() {
  // Config
  document.getElementById('debugConfig').textContent =
    `Airport : ${AIRPORT.icao} — ${AIRPORT.name}\n` +
    `Center  : ${AIRPORT.lat}°N, ${AIRPORT.lon}°E\n` +
    `Radius  : ${AIRPORT.radius_km} km\n` +
    `BBOX    : lamin=${BBOX.lamin.toFixed(4)} lomin=${BBOX.lomin.toFixed(4)} lamax=${BBOX.lamax.toFixed(4)} lomax=${BBOX.lomax.toFixed(4)}\n` +
    `Runways : ${AIRPORT.runways.map(r => r.id).join(', ')}`;

  // Last error
  document.getElementById('debugError').textContent = window._lastError || 'None';

  // Server /api/debug
  try {
    const r = await fetch('/api/debug');
    const j = await r.json();
    document.getElementById('debugServer').textContent =
      `Status          : HTTP ${r.status}\n` +
      `Mode            : ${j.mode}\n` +
      `OPENSKY_USER    : ${j.opensky_user_set ? '✓ set → ' + j.opensky_user_value : '✗ NOT SET'}\n` +
      `OPENSKY_PASS    : ${j.opensky_pass_set ? '✓ set (' + j.opensky_pass_length + ' chars)' : '✗ NOT SET'}\n` +
      `Node version    : ${j.node_version}\n` +
      `Server time     : ${j.time}`;
  } catch(e) {
    document.getElementById('debugServer').textContent = 'Failed to reach /api/debug: ' + e.message;
  }

  // Raw OpenSky call
  try {
    const url = `/api/opensky?lamin=${BBOX.lamin.toFixed(4)}&lomin=${BBOX.lomin.toFixed(4)}&lamax=${BBOX.lamax.toFixed(4)}&lomax=${BBOX.lomax.toFixed(4)}`;
    const r = await fetch(url);
    const text = await r.text();
    let preview = '';
    try {
      const j = JSON.parse(text);
      const stateCount = j.states ? j.states.length : 0;
      preview = `HTTP Status : ${r.status}\n` +
                `States      : ${stateCount} aircraft\n` +
                `Time        : ${j.time}\n\n` +
                `Raw (first 500 chars):\n${text.substring(0, 500)}`;
    } catch {
      preview = `HTTP Status : ${r.status}\nBody: ${text.substring(0, 500)}`;
    }
    document.getElementById('debugOpensky').textContent = preview;
  } catch(e) {
    document.getElementById('debugOpensky').textContent = 'Failed: ' + e.message;
  }
}

// Init
window.addEventListener('load', () => {
  // Init runway cards
  AIRPORT.runways.forEach(rwy => {
    const card = document.createElement('div');
    card.className = 'runway-card';
    card.innerHTML = `<div class="rwy-name">${rwy.id}</div><div class="rwy-hdg">HDG ${String(rwy.heading).padStart(3,'0')}°</div>`;
    document.getElementById('runwayCards').appendChild(card);
  });

  startAutoRefresh();
});


</script>
</body>
</html>
